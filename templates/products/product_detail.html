{% extends 'base.html' %}

{% block title %}{{ product.name }} - Django Marketplace{% endblock %}

{% block content %}
<div class="row">
    <!-- Product Images -->
    <div class="col-md-6">
        {% if product.image %}
            <img src="{{ product.image.url }}" class="img-fluid rounded" 
                 alt="{{ product.name }}" style="width: 100%; max-height: 400px; object-fit: cover;">
        {% else %}
            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                 style="height: 400px;">
                <i class="fas fa-image fa-5x text-muted"></i>
            </div>
        {% endif %}
        
        <!-- Additional Images -->
        {% if product.additional_images.exists %}
        <div class="row mt-3">
            {% for image in product.additional_images.all %}
            <div class="col-3">
                <img src="{{ image.image.url }}" class="img-fluid rounded" 
                     alt="{{ image.alt_text }}" style="height: 80px; object-fit: cover; cursor: pointer;">
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- Product Details -->
    <div class="col-md-6">
        <h1 class="display-6">{{ product.name }}</h1>
        
        {% if product.category %}
        <p class="text-muted">
            <i class="fas fa-tag"></i> {{ product.category.name }}
        </p>
        {% endif %}
        
        <div class="mb-3">
            <span class="h3 text-success">${{ product.price }}</span>
        </div>
        
        <div class="mb-3">
            <strong>Seller:</strong> 
            <span class="badge bg-primary">{{ product.seller.username }}</span>
        </div>
        
        <div class="mb-3">
            <strong>Stock:</strong>
            {% if product.stock_quantity > 0 %}
                <span class="text-success">
                    <i class="fas fa-check-circle"></i> {{ product.stock_quantity }} available
                </span>
            {% else %}
                <span class="text-danger">
                    <i class="fas fa-times-circle"></i> Out of stock
                </span>
            {% endif %}
        </div>
        
        <div class="mb-4">
            <strong>Description:</strong>
            <p class="mt-2">{{ product.description|linebreaks }}</p>
        </div>
        
        <!-- Action Buttons -->
        <div class="mb-4">
            {% if product.is_available %}
                {% if user.is_authenticated %}
                    {% if user != product.seller %}
                        <button class="btn btn-success btn-lg me-2 add-to-cart-btn"
                                data-product-id="{{ product.pk }}" 
                                data-product-name="{{ product.name }}">
                            <i class="fas fa-cart-plus"></i> Add to Cart
                        </button>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#buyNowModal">
                            <i class="fas fa-bolt"></i> Buy Now
                        </button>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> This is your own product.
                        </div>
                    {% endif %}
                {% else %}
                    <a href="{% url 'account_login' %}" class="btn btn-success btn-lg me-2">
                        Login to Add to Cart
                    </a>
                    <a href="{% url 'account_login' %}" class="btn btn-primary btn-lg">
                        Login to Buy Now
                    </a>
                {% endif %}
            {% else %}
                <button class="btn btn-secondary btn-lg" disabled>
                    <i class="fas fa-times"></i> Out of Stock
                </button>
            {% endif %}
        </div>
        
        <!-- Product Meta -->
        <div class="border-top pt-3">
            <small class="text-muted">
                <strong>Product ID:</strong> #{{ product.id }} |
                <strong>Added:</strong> {{ product.created_at|date:"M d, Y" }}
                {% if product.updated_at != product.created_at %}
                | <strong>Updated:</strong> {{ product.updated_at|date:"M d, Y" }}
                {% endif %}
            </small>
        </div>
    </div>
</div>

<!-- Buy Now Modal -->
<div class="modal fade" id="buyNowModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Buy {{ product.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-4">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" class="img-fluid rounded" alt="{{ product.name }}">
                        {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 100px;">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-8">
                        <h6>{{ product.name }}</h6>
                        <p class="text-muted small">{{ product.description|truncatewords:20 }}</p>
                        <p><strong>Price: ${{ product.price }}</strong></p>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity:</label>
                            <select class="form-select" id="quantity">
                                {% for i in "12345678910"|make_list %}
                                    {% if forloop.counter <= product.stock_quantity %}
                                        <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    This will take you to the checkout page to complete your purchase.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">
                    <i class="fas fa-credit-card"></i> Proceed to Checkout
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Related Products -->
{% if related_products %}
<div class="row mt-5">
    <div class="col-12">
        <h3>Related Products</h3>
        <hr>
    </div>
    {% for product in related_products %}
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100">
            {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top" 
                     alt="{{ product.name }}" style="height: 150px; object-fit: cover;">
            {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                     style="height: 150px;">
                    <i class="fas fa-image text-muted"></i>
                </div>
            {% endif %}
            <div class="card-body">
                <h6 class="card-title">{{ product.name }}</h6>
                <p class="card-text"><strong class="text-success">${{ product.price }}</strong></p>
                <a href="{% url 'products:detail' product.pk %}" class="btn btn-primary btn-sm">
                    View Details
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mt-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'products:list' %}">Products</a></li>
        {% if product.category %}
            <li class="breadcrumb-item">{{ product.category.name }}</li>
        {% endif %}
        <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
</nav>
{% endblock %}